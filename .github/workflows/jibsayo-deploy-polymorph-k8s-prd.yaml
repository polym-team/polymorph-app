name: Deploy jibsayo to Polymorph K8s Production

on:
  push:
    branches: ["main"]
    paths:
      # jibsayo와 관련된 코드가 바뀔 때만 실행
      - "apps/jibsayo/**"
      - "packages/**" # 공통 패키지 변경 시에도 재배포 필요
      - ".github/workflows/jibsayo-deploy-polymorph-k8s-prd.yaml"
      - "package.json"
      - "pnpm-lock.yaml"
  # [추가] 수동 실행 버튼 활성화
  workflow_dispatch:

# [추가] 이 부분이 있어야 봇이 git push를 할 수 있습니다!
permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Checkout polymorph-k8s
        uses: actions/checkout@v3
        with:
          repository: polym-team/polymorph-k8s
          token: ${{ secrets.POLYMORPH_GIT_PAT }}
          path: polymorph-k8s

      - name: Generate .env from K8s Secret
        run: |
          # yq 설치
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

          # secret.yaml에서 .env 생성
          yq '.stringData | to_entries | .[] | .key + "=" + "\"" + .value + "\""' \
            polymorph-k8s/manifests/jibsayo/secret.yaml > apps/jibsayo/.env

          echo "Generated .env file:"
          cat apps/jibsayo/.env | head -5
          echo "..."

      - name: Login to Docker Registry
        uses: docker/login-action@v3
        with:
          registry: registry.polymorph.co.kr
          username: ${{ secrets.POLYMORPH_DOCKER_REG_ID }}
          password: ${{ secrets.POLYMORPH_DOCKER_REG_PW }}

      # [핵심] 여기서 도커 이미지를 빌드하고 푸시합니다.
      # 이 단계가 실행될 때 Dockerfile 내부의 'RUN turbo prune...'과 'RUN pnpm build...'가 작동합니다.
      - name: Build and Push Docker Image
        uses: docker/build-push-action@v4
        with:
          context: . # 프로젝트 루트 디렉토리를 컨텍스트로 지정 (중요!)
          file: apps/jibsayo/Dockerfile # jibsayo의 Dockerfile 경로
          push: true
          tags: registry.polymorph.co.kr/jibsayo-nextjs:${{ github.sha }}
          provenance: false
          sbom: false

      # polymorph-k8s 저장소의 이미지 태그 업데이트
      - name: Update image tag in polymorph-k8s
        run: |
          cd polymorph-k8s

          git config user.email "github-actions@github.com"
          git config user.name "GitHub Actions"

          # jibsayo 디렉토리의 deployment.yaml 이미지 태그 수정
          sed -i "s|image:.*|image: registry.polymorph.co.kr/jibsayo-nextjs:${{ github.sha }}|g" manifests/jibsayo/deployment.yaml

          git add manifests/jibsayo/deployment.yaml
          git commit -m "chore(jibsayo): update image to ${{ github.sha }}"

          # Retry loop for concurrent push handling
          max_attempts=5
          for i in $(seq 1 $max_attempts); do
            git push && break
            if [ $i -lt $max_attempts ]; then
              echo "Push failed, retrying... (attempt $i/$max_attempts)"
              sleep $((i * 2))
              git pull --rebase
            else
              echo "Push failed after $max_attempts attempts"
              exit 1
            fi
          done

      - name: Notify Slack
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            COLOR="good"
            STATUS="성공"
            EMOJI=":white_check_mark:"
          else
            COLOR="danger"
            STATUS="실패"
            EMOJI=":x:"
          fi

          curl -X POST ${{ secrets.SLACK_WEBHOOK_URL }} \
            -H 'Content-type: application/json' \
            --data '{
              "attachments": [{
                "color": "'"$COLOR"'",
                "title": "'"$EMOJI"' jibsayo 배포 '"$STATUS"'",
                "fields": [
                  { "title": "브랜치", "value": "${{ github.ref_name }}", "short": true },
                  { "title": "커밋", "value": "`${{ github.sha }}`", "short": true },
                  { "title": "실행자", "value": "${{ github.actor }}", "short": true },
                  { "title": "워크플로우", "value": "<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|상세 보기>", "short": true }
                ]
              }]
            }'
