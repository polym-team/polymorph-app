name: Deploy bookmark-share to Polymorph K8s Production

on:
  push:
    branches: ["main"]
    paths:
      - "apps/bookmark-share/**"
      - "packages/**"
      - ".github/workflows/bookmark-share-deploy-polymorph-k8s-prd.yaml"
      - "package.json"
      - "pnpm-lock.yaml"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Checkout polymorph-k8s
        uses: actions/checkout@v3
        with:
          repository: polym-team/polymorph-k8s
          token: ${{ secrets.POLYMORPH_GIT_PAT }}
          path: polymorph-k8s

      - name: Generate .env from K8s Secret
        run: |
          # yq 설치
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

          # secret.yaml에서 .env 생성
          yq '.stringData | to_entries | .[] | .key + "=" + "\"" + .value + "\""' \
            polymorph-k8s/manifests/bookmark-share/secret.yaml > apps/bookmark-share/.env

          echo "Generated .env file:"
          cat apps/bookmark-share/.env

      - name: Login to Docker Registry
        uses: docker/login-action@v3
        with:
          registry: registry.polymorph.co.kr
          username: ${{ secrets.POLYMORPH_DOCKER_REG_ID }}
          password: ${{ secrets.POLYMORPH_DOCKER_REG_PW }}

      - name: Build and Push Docker Image
        uses: docker/build-push-action@v4
        with:
          context: .
          file: apps/bookmark-share/Dockerfile
          push: true
          tags: registry.polymorph.co.kr/bookmark-share:${{ github.sha }}
          provenance: false
          sbom: false

      - name: Update image tag in polymorph-k8s
        run: |
          cd polymorph-k8s

          git config user.email "github-actions@github.com"
          git config user.name "GitHub Actions"

          sed -i "s|image: registry.polymorph.co.kr/bookmark-share:.*|image: registry.polymorph.co.kr/bookmark-share:${{ github.sha }}|g" manifests/bookmark-share/deployment.yaml

          git add manifests/bookmark-share/deployment.yaml
          git commit -m "chore(bookmark-share): update image to ${{ github.sha }}"
          git push
